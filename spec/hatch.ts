import test from 'ava'
import { GeometryLine, HatchGeometries, getHatchByPosition, mergeHatchBorders, optimizeHatch } from '../src'

test('getHatchByPosition', (t) => {
  const lines1: HatchGeometries[] = [
    {
      id: 51,
      lines: [
        [
          {
            "x": 1569.672079185588,
            "y": -967.320126304418
          },
          {
            "x": 1520.426041943872,
            "y": -989.7145918996004
          }
        ],
        [
          {
            "x": 1520.426041943872,
            "y": -989.7145918996004
          },
          {
            "x": 1519.5742562290814,
            "y": -1043.8067238080619
          }
        ],
        [
          {
            "x": 1519.5742562290814,
            "y": -1043.8067238080619
          },
          {
            "x": 1483.0579913825236,
            "y": -1003.8912296364704
          }
        ],
        [
          {
            "x": 1483.0579913825236,
            "y": -1003.8912296364704
          },
          {
            "x": 1431.3501005892483,
            "y": -1019.7965213036176
          }
        ],
        [
          {
            "x": 1431.3501005892483,
            "y": -1019.7965213036176
          },
          {
            "x": 1458.0278450135988,
            "y": -972.7329236326433
          }
        ],
        [
          {
            "x": 1458.0278450135988,
            "y": -972.7329236326433
          },
          {
            "x": 1426.9223967315775,
            "y": -928.4708025754594
          }
        ],
        [
          {
            "x": 1426.9223967315775,
            "y": -928.4708025754594
          },
          {
            "x": 1479.9264143755668,
            "y": -939.2993937535383
          }
        ],
        [
          {
            "x": 1479.9264143755668,
            "y": -939.2993937535383
          },
          {
            "x": 1512.4100808952508,
            "y": -896.0386068588889
          }
        ],
        [
          {
            "x": 1512.4100808952508,
            "y": -896.0386068588889
          },
          {
            "x": 1518.4906209151848,
            "y": -949.7946419281933
          }
        ],
        [
          {
            "x": 1518.4906209151848,
            "y": -949.7946419281933
          },
          {
            "x": 1569.672079185588,
            "y": -967.320126304418
          }
        ]
      ]
    },
    {
      id: 52,
      lines: [
        {
          "type": "ellipse arc",
          "curve": {
            "cx": 1399.8553625758855,
            "cy": -882.9926913475381,
            "rx": 73.20201149711428,
            "ry": 94.15669390830384,
            "angle": 78.38988271340202,
            "startAngle": 0,
            "endAngle": 360
          }
        }
      ]
    }
  ]
  t.snapshot(getHatchByPosition({ x: 1506, y: -1002 }, { x: 4827.926789679547, y: -1002 }, () => lines1))
  t.snapshot(getHatchByPosition({ x: 1400, y: -892 }, { x: 4827.926789679547, y: -892 }, () => lines1))

  const lines2: HatchGeometries[] = [
    {
      id: 57,
      lines: [
        {
          "type": "ray",
          "line": {
            "x": 1405.0831204195404,
            "y": -682.4019248502226,
            "angle": 30,
            "bidirectional": false
          }
        }
      ]
    },
    {
      id: 58,
      lines: [
        [
          {
            "x": 1668.8931412624152,
            "y": -760.0738351475334
          },
          {
            "x": 1890.760695280792,
            "y": -296.37064724912534
          }
        ]
      ]
    },
    {
      id: 56,
      lines: [
        [
          {
            "x": 1786.3035573522566,
            "y": -716.2582768398402
          },
          {
            "x": 1463.486320583276,
            "y": -393.44104007085934
          }
        ]
      ]
    }
  ]
  t.snapshot(getHatchByPosition({ x: 1710, y: -571 }, { x: 2294, y: -571 }, () => lines2))

  const lines3: HatchGeometries[] = [
    {
      id: 57,
      lines: [
        {
          "type": "ray",
          "line": {
            "x": 1405.0831204195404,
            "y": -682.4019248502226,
            "angle": 30,
            "bidirectional": true
          }
        }
      ]
    },
    {
      id: 58,
      lines: [
        [
          {
            "x": 1668.8931412624152,
            "y": -760.0738351475334
          },
          {
            "x": 1890.760695280792,
            "y": -296.37064724912534
          }
        ]
      ]
    },
    {
      id: 56,
      lines: [
        [
          {
            "x": 1786.3035573522566,
            "y": -716.2582768398402
          },
          {
            "x": 1463.486320583276,
            "y": -393.44104007085934
          }
        ]
      ]
    }
  ]
  t.snapshot(getHatchByPosition({ x: 1710, y: -571 }, { x: 2294, y: -571 }, () => lines3))
  t.snapshot(getHatchByPosition({ x: 1411, y: -858 }, { x: 4827.926789679547, y: -858 }, () => lines1))

  const lines4: HatchGeometries[] = [
    {
      id: 59,
      lines: [
        {
          "type": "ellipse arc",
          "curve": {
            "cx": 1370.7273710925747,
            "cy": -1134.5660224346493,
            "rx": 60.335450901039835,
            "ry": 99.30401857424064,
            "angle": -73.99771614853803,
            "startAngle": 0,
            "endAngle": 360
          }
        }
      ]
    },
    {
      id: 60,
      lines: [
        [
          {
            "x": 1374.8399900996874,
            "y": -1268.153510021977
          },
          {
            "x": 1451.983740535535,
            "y": -1242.4830352082136
          }
        ],
        [
          {
            "x": 1451.983740535535,
            "y": -1242.4830352082136
          },
          {
            "x": 1426.6652452755125,
            "y": -1166.3970378154747
          }
        ],
        [
          {
            "x": 1426.6652452755125,
            "y": -1166.3970378154747
          },
          {
            "x": 1349.521494839665,
            "y": -1192.067512629238
          }
        ],
        [
          {
            "x": 1349.521494839665,
            "y": -1192.067512629238
          },
          {
            "x": 1374.8399900996874,
            "y": -1268.153510021977
          }
        ]
      ]
    }
  ]
  t.snapshot(getHatchByPosition({ x: 1400, y: -1217 }, { x: 2000, y: -1217 }, () => lines4))
})

test('optimize hatch', t => {
  const lines1: GeometryLine[] = [
    [
      {
        "x": 239.08937794084397,
        "y": -78.63685178175092
      },
      {
        "x": 95.39018789970345,
        "y": -78.63685178175098
      }
    ],
    [
      {
        "x": 95.39018789970346,
        "y": -78.63685178175098
      },
      {
        "x": 167.2397829202737,
        "y": -203.08400086062642
      }
    ],
    [
      {
        "x": 167.23978292027374,
        "y": -203.08400086062647
      },
      {
        "x": 239.08937794084397,
        "y": -78.63685178175092
      }
    ]
  ]
  const lines2: GeometryLine[] = [
    [
      {
        "x": 239.08937794084397,
        "y": -78.63685178175092
      },
      {
        "x": 150.7006640929202,
        "y": -78.63685178175095
      }
    ],
    [
      {
        "x": 150.70066409292022,
        "y": -78.63685178175099
      },
      {
        "x": 198.63849526025217,
        "y": -148.69983579554383
      }
    ],
    [
      {
        "x": 198.63849526025217,
        "y": -148.69983579554392
      },
      {
        "x": 239.08937794084397,
        "y": -78.63685178175092
      }
    ]
  ]
  t.snapshot(optimizeHatch(lines1, [lines2]))

  const border: GeometryLine[] = [
    [
      {
        "x": 239.08937794084397,
        "y": -78.63685178175092
      },
      {
        "x": 95.39018789970345,
        "y": -78.63685178175098
      }
    ],
    [
      {
        "x": 95.39018789970346,
        "y": -78.63685178175098
      },
      {
        "x": 167.2397829202737,
        "y": -203.08400086062642
      }
    ],
    [
      {
        "x": 167.23978292027374,
        "y": -203.08400086062647
      },
      {
        "x": 239.08937794084397,
        "y": -78.63685178175092
      }
    ]
  ]
  const holes1: GeometryLine[] = [
    [
      {
        "x": 192.26602992137714,
        "y": -105.63779185026317
      },
      {
        "x": 173.12801553254636,
        "y": -149.3337085108719
      }
    ],
    [
      {
        "x": 173.12801553254636,
        "y": -149.3337085108719
      },
      {
        "x": 144.85524885722688,
        "y": -110.91174354184798
      }
    ],
    [
      {
        "x": 144.85524885722688,
        "y": -110.91174354184798
      },
      {
        "x": 192.2660299213771,
        "y": -105.63779185026317
      }
    ]
  ]
  const holes2: GeometryLine[] = [
    [
      {
        "x": 239.08937794084397,
        "y": -78.63685178175092
      },
      {
        "x": 151.78931495529255,
        "y": -78.63685178175095
      }
    ],
    [
      {
        "x": 151.78931495529255,
        "y": -78.63685178175096
      },
      {
        "x": 172.83780898546271,
        "y": -107.79897747871354
      }
    ],
    [
      {
        "x": 172.83780898546271,
        "y": -107.79897747871355
      },
      {
        "x": 192.2660299213771,
        "y": -105.63779185026317
      }
    ],
    [
      {
        "x": 192.26602992137714,
        "y": -105.63779185026317
      },
      {
        "x": 184.33987698290156,
        "y": -123.73478515386302
      }
    ],
    [
      {
        "x": 184.33987698290156,
        "y": -123.73478515386296
      },
      {
        "x": 200.29195396983732,
        "y": -145.8359613023251
      }
    ],
    [
      {
        "x": 200.29195396983732,
        "y": -145.83596130232516
      },
      {
        "x": 239.08937794084397,
        "y": -78.63685178175092
      }
    ]
  ]
  t.snapshot(optimizeHatch(border, [holes1, holes2]))
})

test('merge hatch borders', t => {
  const a: GeometryLine[] = [
    [
      {
        "x": 440.9990201124589,
        "y": -127.18144880772601
      },
      {
        "x": 405.4868569220065,
        "y": -175.92342669055813
      }
    ],
    [
      {
        "x": 405.4868569220065,
        "y": -175.92342669055813
      },
      {
        "x": 465.45472959446454,
        "y": -182.30687321541245
      }
    ],
    [
      {
        "x": 465.45472959446454,
        "y": -182.30687321541245
      },
      {
        "x": 440.9990201124589,
        "y": -127.18144880772601
      }
    ]
  ]
  const b: GeometryLine[] = [
    [
      {
        "x": 492.02369603467093,
        "y": -154.9884952247211
      },
      {
        "x": 450.0826330203099,
        "y": -147.6567499666995
      }
    ],
    [
      {
        "x": 450.0826330203099,
        "y": -147.6567499666994
      },
      {
        "x": 458.55365389377425,
        "y": -166.75121218868827
      }
    ],
    [
      {
        "x": 458.55365389377425,
        "y": -166.75121218868838
      },
      {
        "x": 492.02369603467093,
        "y": -154.9884952247211
      }
    ]
  ]
  t.snapshot(mergeHatchBorders(a, b))

  const c: GeometryLine[] = [
    [
      {
        "x": 492.02369603467093,
        "y": -154.9884952247211
      },
      {
        "x": 450.0826330203099,
        "y": -147.6567499666995
      }
    ],
    [
      {
        "x": 450.0826330203099,
        "y": -147.6567499666994
      },
      {
        "x": 454,
        "y": -166.75121218868827
      }
    ],
    [
      {
        "x": 454,
        "y": -166.75121218868838
      },
      {
        "x": 492.02369603467093,
        "y": -154.9884952247211
      }
    ]
  ]
  t.snapshot(mergeHatchBorders(a, c))
})
